<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecretSwap.fun - Exchange your secrets anonymously</title>
    <script src="https://www.paypal.com/sdk/js?client-id=BAASqHmRUaw9JpJWNA3d0XElWNNDdRQdytHNxWDxEtZTz8gICMWyhyqiKfNtkbc4Q8-f2aYdN5VR_ailf8&components=hosted-buttons&disable-funding=venmo&currency=USD"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/toxicity"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="model-status" id="modelStatus">
        <div class="spinner"></div>
        Loading content moderation model...
    </div>
    
    <header>
        <div class="logo">
            <div class="logo-icon">🤫</div>
            <h1>SecretSwap<span class="fun">.fun</span></h1>
        </div>
        <p class="tagline">Share your secrets anonymously and get one in return</p>
    </header>
    
    <div class="container" id="secretFormContainer">
        <div class="step">
            <h2><span>1</span> Share your secret</h2>
            <textarea 
                id="secretInput" 
                class="secret-input" 
                placeholder="Write what's on your mind... (min 100, max 500 characters)"></textarea>
            <div class="char-count"><span id="charCount">0</span>/500 characters</div>
            <div class="error-message" id="lengthError">Secret must be at least 100 characters long</div>
            <div class="moderation-message" id="moderationMessage">
    <div class="toxicity-summary">Inappropriate content detected</div>
    <p>Your secret contains toxic language or code (<span class="toxicity-percent">0%</span>). Please rephrase your message.</p>
    <div class="toxicity-bar">
        <div class="toxicity-level" id="toxicityLevel"></div>
    </div>
    <div class="toxicity-labels">
        <span>Safe</span>
        <span>Toxic</span>
    </div>
</div>
        </div>
        
        <div class="step">
            <h2><span>2</span> Choose your emotion</h2>
            <div class="emotion-selector">
                <button class="emotion-btn" data-emotion="😤" title="Excessive Pride - Feeling of superiority">😤</button>
                <button class="emotion-btn" data-emotion="🤑" title="Greed - Obsessive desire for possessions">🤑</button>
                <button class="emotion-btn" data-emotion="😒" title="Envy - Resentment of others' success">😒</button>
                <button class="emotion-btn" data-emotion="😠" title="Wrath - Violent and destructive emotion">😠</button>
                <button class="emotion-btn" data-emotion="😏" title="Lust - Uncontrollable desire">😏</button>
                <button class="emotion-btn" data-emotion="😋" title="Gluttony - Excessive pursuit of pleasure">😋</button>
                <button class="emotion-btn" data-emotion="😑" title="Sloth - Lack of energy and interest">😑</button>
            </div>
            <div class="error-message" id="emotionError">Please select an emotion</div>
        </div>
        
        <button id="submitBtn" class="submit-btn" disabled>Share anonymously</button>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Looking for a similar secret...</p>
        </div>
    </div>
    
    <div class="container" id="resultContainer">
        <h2 id="resultTitle">Here is a secret similar to yours:</h2>
        <div class="secret-result" id="secretResult">
            Loading your secret...
        </div>
        
        <div class="actions-container" id="actionsContainer">
            <button class="action-btn keep-btn" data-action="keep">
                <span>📁</span> Keep
            </button>
            <button class="action-btn forget-btn" data-action="forget">
                <span>🧹</span> Forget
            </button>
            <button class="action-btn support-btn" data-action="support">
                <span>🤗</span> Support
            </button>
            <button class="action-btn reveal-btn" data-action="reveal">
                <span>📣</span> Reveal
            </button>
        </div>
        
        <div class="paypal-container" id="paypalContainer">
            <div class="paypal-text">How much do you value this secret?</div>
            <div id="paypal-container-DKK8KM24TAJRE"></div>
        </div>
        
        <div class="stats-display" id="statsDisplay">
            <div class="stats-title">Community Response</div>
            <div class="stats-grid">
                <div class="stat-display">
                    <div class="stat-display-value" id="keepStat">0</div>
                    <div class="stat-display-label">Keep</div>
                </div>
                <div class="stat-display">
                    <div class="stat-display-value" id="forgetStat">0</div>
                    <div class="stat-display-label">Forget</div>
                </div>
                <div class="stat-display">
                    <div class="stat-display-value" id="supportStat">0</div>
                    <div class="stat-display-label">Support</div>
                </div>
                <div class="stat-display">
                    <div class="stat-display-value" id="revealStat">0</div>
                    <div class="stat-display-label">Reveal</div>
                </div>
            </div>
        </div>
        
        <div class="thank-you-message" id="thankYouMessage">
            Thank you for participating!
        </div>
        
        <button class="restart-btn" id="restartBtn">Share another secret</button>
    </div>
    
    <div class="how-it-works">
        <h2>How it works?</h2>
        <div class="steps">
            <div class="step-card">
                <div class="step-icon">🔒</div>
                <div class="step-number">1</div>
                <h3>Share anonymously</h3>
                <p>Write your secret and choose your current emotion.</p>
            </div>
            <div class="step-card">
                <div class="step-icon">🔄</div>
                <div class="step-number">2</div>
                <h3>Receive a secret</h3>
                <p>Instantly get a secret from someone feeling the same.</p>
            </div>
            <div class="step-card">
                <div class="step-icon">💌</div>
                <div class="step-number">3</div>
                <h3>Support others</h3>
                <p>Keep, forget, or support a secret.</p>
            </div>
            <div class="step-card">
                <div class="step-icon">🦊</div>
                <div class="step-number">4</div>
                <h3>Release it</h3>
                <p>Share this secret with the whole world!</p>
            </div>
        </div>
    </div>
    
    <div class="stats-container">
        <h2>Community Secrets Statistics</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">🤫</div>
                <div class="stat-value" id="totalSecrets">0</div>
                <div class="stat-label">Total Secrets</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">😤</div>
                <div class="stat-value" id="emotion1">0</div>
                <div class="stat-label">Excessive Pride</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🤑</div>
                <div class="stat-value" id="emotion2">0</div>
                <div class="stat-label">Greed</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">😒</div>
                <div class="stat-value" id="emotion3">0</div>
                <div class="stat-label">Envy</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">😠</div>
                <div class="stat-value" id="emotion4">0</div>
                <div class="stat-label">Wrath</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">😏</div>
                <div class="stat-value" id="emotion5">0</div>
                <div class="stat-label">Lust</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">😋</div>
                <div class="stat-value" id="emotion6">0</div>
                <div class="stat-label">Gluttony</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">😑</div>
                <div class="stat-value" id="emotion7">0</div>
                <div class="stat-label">Sloth</div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h2>Your secrets are safe</h2>
        <div class="features">
            <div class="feature">
                <div class="feature-icon">🔐</div>
                <h3>Total anonymity</h3>
                <p>No personal information is collected or stored.</p>
            </div>
            <div class="feature">
                <div class="feature-icon">🔄</div>
                <h3>Instant exchanges</h3>
                <p>Receive a similar secret as soon as you share yours.</p>
            </div>
            <div class="feature">
                <div class="feature-icon">💖</div>
                <h3>Caring community</h3>
                <p>A judgment-free space to free yourself.</p>
            </div>
            <div class="feature">
                <div class="feature-icon">🛡️</div>
                <h3>Content moderation</h3>
                <p>All secrets are checked for inappropriate content.</p>
            </div>
        </div>
    </div>
    
    <div class="revealed-secrets-container">
        <h2 class="revealed-secrets-title">Revealed Secrets</h2>
        <div class="loading" id="revealedLoading">
            <div class="spinner"></div>
            <p>Loading revealed secrets...</p>
        </div>
        <div class="secrets-grid" id="revealedSecretsGrid">
            <!-- Revealed secrets will be loaded here -->
        </div>
    </div>
    
    <footer>
        <p>© 2025 SecretSwap.fun - All rights reserved</p>
        <p>An anonymous and caring space to share what's on your mind</p>
        <p><a href="bitcoin/" target="_blank">Double or nothing </a> | <a href="#">Terms of Use</a></p>
    </footer>
<script>
    // Configuration
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyDhDfjo9rPdoD36ki8ofSvvjLECfnrh2gk9XBgmYoZtJ5JABKYqHM_ofHdGO7mjFO_Ig/exec";
    
    // DOM Elements
    const secretInput = document.getElementById('secretInput');
    const charCount = document.getElementById('charCount');
    const lengthError = document.getElementById('lengthError');
    const emotionError = document.getElementById('emotionError');
    const emotionBtns = document.querySelectorAll('.emotion-btn');
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    const resultContainer = document.getElementById('resultContainer');
    const resultTitle = document.getElementById('resultTitle');
    const secretResult = document.getElementById('secretResult');
    const actionsContainer = document.getElementById('actionsContainer');
    const thankYouMessage = document.getElementById('thankYouMessage');
    const actionBtns = document.querySelectorAll('.action-btn');
    const secretFormContainer = document.getElementById('secretFormContainer');
    const revealedLoading = document.getElementById('revealedLoading');
    const revealedSecretsGrid = document.getElementById('revealedSecretsGrid');
    const paypalContainer = document.getElementById('paypalContainer');
    const statsDisplay = document.getElementById('statsDisplay');
    const keepStat = document.getElementById('keepStat');
    const forgetStat = document.getElementById('forgetStat');
    const supportStat = document.getElementById('supportStat');
    const revealStat = document.getElementById('revealStat');
    const restartBtn = document.getElementById('restartBtn');
    const modelStatus = document.getElementById('modelStatus');
    const moderationMessage = document.getElementById('moderationMessage');
    const toxicityLevel = document.getElementById('toxicityLevel');
    const totalSecrets = document.getElementById('totalSecrets');
    const emotion1 = document.getElementById('emotion1');
    const emotion2 = document.getElementById('emotion2');
    const emotion3 = document.getElementById('emotion3');
    const emotion4 = document.getElementById('emotion4');
    const emotion5 = document.getElementById('emotion5');
    const emotion6 = document.getElementById('emotion6');
    const emotion7 = document.getElementById('emotion7');
    
    let selectedEmotion = null;
    let currentRowId = null;
    let actionTaken = false;
    let secretStats = { keep: 0, forget: 0, support: 0, reveal: 0 };
    let toxicityModel = null;
    
    // Vérification de code (version optimisée)
    function containsCode(text) {
        // Patterns spécifiques uniquement pour code visible
        const patterns = [
            /<[a-z][\s\S]*>/i,                         // Balises HTML
            /function\s*\([^)]*\)\s*\{/,               // Déclaration fonction
            /(?:^|\s)(var|let|const)\s+\w+\s*=[^;]+;/,  // Variables JS
            /\.\w+\([^)]*\)/,                          // Appels méthode
            /\/\/|\/\*[\s\S]*?\*\//,                   // Commentaires
            /(?:^|\s)(if|for|while|switch)\s*\(/,      // Structures contrôle
            /(?:^|\s)(def|class)\s+\w+\s*\(?/,         // Python
            /(?:^|\s)(import|from|require|export)\s+/, // Imports
            /console\.log\(|alert\(|document\./i        // Fonctions spécifiques
        ];
        
        // Exclure les faux positifs courants
        const falsePositives = [
            /\([^)]{0,20}\)/,                     // Parenthèses courtes
            /[a-z]\.(com|org|net)/i,              // Domaines internet
            /:\/\/|www\./,                        // URLs
            /=>|->|\+\+|--/                       // Symboles communs
        ];
        
        // Vérifier les patterns de code
        const hasCode = patterns.some(pattern => pattern.test(text));
        
        // Vérifier les faux positifs
        const hasFalsePositive = falsePositives.some(pattern => pattern.test(text));
        
        return hasCode && !hasFalsePositive;
    }
    
    // Initialisation modèle de toxicité
    async function initToxicityModel() {
        try {
            modelStatus.style.display = 'block';
            toxicityModel = await toxicity.load(0.4, [
                'toxicity', 'severe_toxicity', 'identity_attack', 
                'insult', 'threat', 'sexual_explicit'
            ]);
            
            setTimeout(() => {
                modelStatus.style.display = 'none';
            }, 1500);
        } catch (error) {
            modelStatus.textContent = "Modération désactivée: " + error.message;
            modelStatus.classList.add('error');
            console.warn("Modération désactivée:", error);
        }
    }
    
    // Vérification toxicité
    async function isToxic(text) {
        if (!toxicityModel) return { isToxic: false, maxScore: 0 };
        
        try {
            const predictions = await toxicityModel.classify([text]);
            let maxScore = 0;
            
            predictions.forEach(prediction => {
                if (prediction.results[0].match) {
                    const score = prediction.results[0].probabilities[1];
                    if (score > maxScore) maxScore = score;
                }
            });
            
            if (maxScore > 0.4) {
                const percent = Math.min(100, Math.round(maxScore * 100));
                toxicityLevel.style.width = `${percent}%`;
                document.querySelector('.toxicity-percent').textContent = `${percent}%`;
                moderationMessage.style.display = 'block';
                return { isToxic: true, maxScore };
            }
            
            moderationMessage.style.display = 'none';
            return { isToxic: false, maxScore };
        } catch (error) {
            console.warn("Erreur modération:", error);
            return { isToxic: false, maxScore: 0 };
        }
    }
    
    // Gestionnaires d'événements
    function setupEventListeners() {
        // Compteur de caractères
        secretInput.addEventListener('input', () => {
            const text = secretInput.value;
            charCount.textContent = text.length;
            lengthError.style.display = text.length < 100 ? 'block' : 'none';
            updateSubmitButton();
        });
        
        // Sélection émotion
        emotionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                emotionBtns.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedEmotion = btn.dataset.emotion;
                emotionError.style.display = 'none';
                updateSubmitButton();
            });
        });
        
        // Soumission secret
        submitBtn.addEventListener('click', submitSecret);
        
        // Actions sur secret
        actionBtns.forEach(btn => {
            btn.addEventListener('click', () => handleSecretAction(btn.dataset.action));
        });
        
        // Recommencer
        restartBtn.addEventListener('click', () => {
            resultContainer.style.display = 'none';
            secretFormContainer.style.display = 'block';
            secretInput.value = '';
            charCount.textContent = '0';
            selectedEmotion = null;
            emotionBtns.forEach(b => b.classList.remove('selected'));
            updateSubmitButton();
            secretFormContainer.scrollIntoView({ behavior: 'smooth' });
        });
    }
    
    // Mise à jour bouton soumission
    function updateSubmitButton() {
        const text = secretInput.value;
        submitBtn.disabled = !(text.length >= 100 && 
                              text.length <= 500 && 
                              selectedEmotion);
    }
    
    // Soumission du secret
    async function submitSecret() {
        const secret = secretInput.value.trim();
        
        // Validation
        if (secret.length < 100) {
            lengthError.style.display = 'block';
            return;
        }
        if (!selectedEmotion) {
            emotionError.style.display = 'block';
            return;
        }
        
        moderationMessage.style.display = 'none';
        loading.style.display = 'block';
        submitBtn.disabled = true;
        
        try {
            // Vérification code
            if (containsCode(secret)) {
                throw new Error("Texte suspecté comme code. Reformulez en langage naturel.");
            }
            
            // Vérification toxicité
            const toxicityResult = await isToxic(secret);
            if (toxicityResult.isToxic) {
                throw new Error(`Contenu inapproprié (${Math.round(toxicityResult.maxScore * 100)}%). Veuillez reformuler.`);
            }
            
            // Envoi au serveur
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'submitSecret',
                    secret: secret,
                    emotion: selectedEmotion
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Erreur serveur');
            }
            
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            
            // Affichage résultat
            showSecretResult(result);
        } catch (error) {
            handleSubmissionError(error);
        } finally {
            loading.style.display = 'none';
            submitBtn.disabled = false;
        }
    }
    
    // Affichage résultat
    function showSecretResult(result) {
        currentRowId = result.rowId;
        secretResult.textContent = result.exchangeSecret || "Aucun secret similaire trouvé";
        secretFormContainer.style.display = 'none';
        resultContainer.style.display = 'block';
        
        // Stats initiales
        secretStats.keep = result.keep || 0;
        secretStats.forget = result.forget || 0;
        secretStats.support = result.support || 0;
        secretStats.reveal = result.reveal || 0;
        updateStatsDisplay();
        
        resultContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Gestion erreurs soumission
    function handleSubmissionError(error) {
        if (error.message.includes("Contenu inapproprié") || 
            error.message.includes("Texte suspecté")) {
            moderationMessage.querySelector('p').textContent = error.message;
            moderationMessage.style.display = 'block';
        } else {
            console.error("Erreur soumission:", error);
            alert(`Erreur: ${error.message || 'Problème de connexion'}`);
        }
    }
    
    // Action sur secret
    async function handleSecretAction(action) {
        if (actionTaken || !currentRowId) return;
        
        actionTaken = true;
        actionBtns.forEach(b => b.disabled = true);
        
        try {
            // Mise à jour compteur
            const response = await fetch(`${SCRIPT_URL}?action=increment&rowId=${currentRowId}&counterType=${action}`);
            if (!response.ok) throw new Error('Échec mise à jour');
            
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            
            // Actualisation stats
            await updateSecretStats();
            
            // Actions spéciales
            if (action === 'reveal') {
                paypalContainer.style.display = 'block';
                initPaypalButton();
                loadRevealedSecrets();
            }
            
            thankYouMessage.style.display = 'block';
        } catch (error) {
            console.error("Erreur action:", error);
            alert(`Erreur: ${error.message}`);
            actionBtns.forEach(b => b.disabled = false);
            actionTaken = false;
        }
    }
    
    // Initialisation bouton PayPal
    function initPaypalButton() {
        if (window.paypal) {
            paypal.HostedButtons({
                hostedButtonId: "DKK8KM24TAJRE",
            }).render("#paypal-container-DKK8KM24TAJRE");
        }
    }
    
    // Mise à jour stats
    async function updateSecretStats() {
        try {
            const response = await fetch(`${SCRIPT_URL}?action=getSecretStats&rowId=${currentRowId}`);
            if (!response.ok) throw new Error('Échec stats');
            
            const result = await response.json();
            if (result.status === 'success') {
                secretStats = {
                    keep: result.keep || 0,
                    forget: result.forget || 0,
                    support: result.support || 0,
                    reveal: result.reveal || 0
                };
                updateStatsDisplay();
                statsDisplay.style.display = 'block';
            }
        } catch (error) {
            console.warn("Erreur stats:", error);
        }
    }
    
    // Affichage stats
    function updateStatsDisplay() {
        keepStat.textContent = secretStats.keep;
        forgetStat.textContent = secretStats.forget;
        supportStat.textContent = secretStats.support;
        revealStat.textContent = secretStats.reveal;
    }
    
    // Chargement secrets révélés
    async function loadRevealedSecrets() {
        revealedLoading.style.display = 'block';
        revealedSecretsGrid.innerHTML = '';
        
        try {
            const response = await fetch(`${SCRIPT_URL}?action=getRevealedSecrets`);
            if (!response.ok) throw new Error('Échec chargement');
            
            const data = await response.json();
            if (data.status === "success" && data.secrets?.length) {
                data.secrets.forEach(secret => {
                    revealedSecretsGrid.appendChild(createSecretCard(secret));
                });
            } else {
                showNoSecretsMessage();
            }
        } catch (error) {
            showSecretsError(error);
        } finally {
            revealedLoading.style.display = 'none';
        }
    }
    
    // Création carte secret
    function createSecretCard(secret) {
        const card = document.createElement('div');
        card.className = 'secret-card';
        card.innerHTML = `
            <div class="secret-emotion">${secret.emotion || '😶'}</div>
            <div class="secret-content">${secret.secret || 'Secret non disponible'}</div>
            <div class="stats-container">
                <div class="stat-item keep-stat">
                    <div class="stat-value">${secret.keep || 0}</div>
                    <div class="stat-label">Keep</div>
                </div>
                <div class="stat-item forget-stat">
                    <div class="stat-value">${secret.forget || 0}</div>
                    <div class="stat-label">Forget</div>
                </div>
                <div class="stat-item support-stat">
                    <div class="stat-value">${secret.support || 0}</div>
                    <div class="stat-label">Support</div>
                </div>
                <div class="stat-item reveal-stat">
                    <div class="stat-value">${secret.reveal || 0}</div>
                    <div class="stat-label">Reveal</div>
                </div>
            </div>
        `;
        return card;
    }
    
    // Message absence secrets
    function showNoSecretsMessage() {
        revealedSecretsGrid.innerHTML = `
            <div class="no-secrets">
                <h3>Aucun secret révélé</h3>
                <p>Soyez le premier à révéler un secret !</p>
            </div>
        `;
    }
    
    // Message erreur secrets
    function showSecretsError(error) {
        revealedSecretsGrid.innerHTML = `
            <div class="error">
                <h3>Erreur de chargement</h3>
                <p>${error.message || 'Problème technique'}</p>
            </div>
        `;
    }
    
    // Chargement stats globales
    async function loadStats() {
        try {
            const response = await fetch(`${SCRIPT_URL}?action=getStats`);
            if (!response.ok) throw new Error('Échec stats');
            
            const data = await response.json();
            if (data.status === 'success') {
                totalSecrets.textContent = data.total || 0;
                emotion1.textContent = data.byEmotion?.['😤'] || 0;
                emotion2.textContent = data.byEmotion?.['🤑'] || 0;
                emotion3.textContent = data.byEmotion?.['😒'] || 0;
                emotion4.textContent = data.byEmotion?.['😠'] || 0;
                emotion5.textContent = data.byEmotion?.['😏'] || 0;
                emotion6.textContent = data.byEmotion?.['😋'] || 0;
                emotion7.textContent = data.byEmotion?.['😑'] || 0;
            }
        } catch (error) {
            console.warn("Erreur stats globales:", error);
        }
    }
    
    // Initialisation
    async function initializeApp() {
        await initToxicityModel();
        setupEventListeners();
        loadRevealedSecrets();
        loadStats();
        
        // État initial UI
        charCount.textContent = secretInput.value.length;
        updateSubmitButton();
        resultContainer.style.display = 'none';
        paypalContainer.style.display = 'none';
        statsDisplay.style.display = 'none';
        thankYouMessage.style.display = 'none';
    }
    
    // Lancement application
    document.addEventListener('DOMContentLoaded', initializeApp);
</script>