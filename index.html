<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecretSwap.fun - Exchange your secrets anonymously</title>
    <script 
  src="https://www.paypal.com/sdk/js?client-id=BAASqHmRUaw9JpJWNA3d0XElWNNDdRQdytHNxWDxEtZTz8gICMWyhyqiKfNtkbc4Q8-f2aYdN5VR_ailf8&components=hosted-buttons&disable-funding=venmo&currency=USD">
</script>
    <!-- Add TensorFlow.js and Toxicity model -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/toxicity"></script>
        <link rel="stylesheet" href="style.css">
    <style>
  
        
        /* New moderation styles */
        .moderation-message {
            background-color: #ffebee;
            border-left: 4px solid var(--danger);
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 15px;
            display: none;
        }
        
        .toxicity-summary {
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .toxicity-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .toxicity-level {
            height: 100%;
            background: var(--danger);
            border-radius: 4px;
        }
        
        .toxicity-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .model-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            background-color: #e3f2fd;
            color: #0d47a1;
            display: none;
        }
        
        .model-status.loaded {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .model-status.error {
            background-color: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="model-status" id="modelStatus">
        <div class="spinner"></div>
        Loading content moderation model...
    </div>
    
    <header>
        <div class="logo">
            <div class="logo-icon">ü§´</div>
            <h1>SecretSwap<span class="fun">.fun</span></h1>
        </div>
        <p class="tagline">Share your secrets anonymously and get one in return</p>
    </header>
    
    <div class="container" id="secretFormContainer">
        <div class="step">
            <h2><span>1</span> Share your secret</h2>
            <textarea 
                id="secretInput" 
                class="secret-input" 
                placeholder="Write what's on your mind... (min 100, max 500 characters)"></textarea>
            <div class="char-count"><span id="charCount">0</span>/500 characters</div>
            <div class="error-message" id="lengthError">Secret must be at least 100 characters long</div>
            <div class="moderation-message" id="moderationMessage">
                <div class="toxicity-summary">Inappropriate content detected</div>
                <p>Your secret contains toxic language or code. Please rephrase your message.</p>
                <div class="toxicity-bar">
                    <div class="toxicity-level" id="toxicityLevel"></div>
                </div>
                <div class="toxicity-labels">
                    <span>Safe</span>
                    <span>Toxic</span>
                </div>
            </div>
        </div>
        
        <div class="step">
            <h2><span>2</span> Choose your emotion</h2>
            <div class="emotion-selector">
                <button class="emotion-btn" data-emotion="üò§" title="Excessive Pride - Feeling of superiority">üò§</button>
        <button class="emotion-btn" data-emotion="ü§ë" title="Greed - Obsessive desire for possessions">ü§ë</button>
        <button class="emotion-btn" data-emotion="üòí" title="Envy - Resentment of others' success">üòí</button>
        <button class="emotion-btn" data-emotion="üò†" title="Wrath - Violent and destructive emotion">üò†</button>
        <button class="emotion-btn" data-emotion="üòè" title="Lust - Uncontrollable desire">üòè</button>
        <button class="emotion-btn" data-emotion="üòã" title="Gluttony - Excessive pursuit of pleasure">üòã</button>
        <button class="emotion-btn" data-emotion="üòë" title="Sloth - Lack of energy and interest">üòë</button>
            </div>
            <div class="error-message" id="emotionError">Please select an emotion</div>
        </div>
        
        <button id="submitBtn" class="submit-btn" disabled>Share anonymously</button>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Looking for a similar secret...</p>
        </div>
    </div>
    
    <div class="container" id="resultContainer" style="display: none;">
        <h2 id="resultTitle">Here is a secret similar to yours:</h2>
        <div class="secret-result" id="secretResult">
            Loading your secret...
        </div>
        
        <div class="actions-container" id="actionsContainer">
            <button class="action-btn keep-btn" data-action="keep">
                <span>üìÅ</span> Keep
            </button>
            <button class="action-btn forget-btn" data-action="forget">
                <span>üßπ</span> Forget
            </button>
            <button class="action-btn support-btn" data-action="support">
                <span>ü§ó</span> Support
            </button>
            <button class="action-btn reveal-btn" data-action="reveal">
                <span>üì£</span> Reveal
            </button>
        </div>
        
        <div class="paypal-container" id="paypalContainer">
            <div class="paypal-text">How much do you value this secret?</div>
            <div id="paypal-container-DKK8KM24TAJRE"></div>
        </div>
        
        <div class="stats-display" id="statsDisplay">
            <div class="stats-title">Community Response</div>
            <div class="stats-grid">
                <div class="stat-display">
                    <div class="stat-display-value" id="keepStat">0</div>
                    <div class="stat-display-label">Keep</div>
                </div>
                <div class="stat-display">
                    <div class="stat-display-value" id="forgetStat">0</div>
                    <div class="stat-display-label">Forget</div>
                </div>
                <div class="stat-display">
                    <div class="stat-display-value" id="supportStat">0</div>
                    <div class="stat-display-label">Support</div>
                </div>
                <div class="stat-display">
                    <div class="stat-display-value" id="revealStat">0</div>
                    <div class="stat-display-label">Reveal</div>
                </div>
            </div>
        </div>
        
        <div class="thank-you-message" id="thankYouMessage">
            Thank you for participating!
        </div>
        
        <button class="restart-btn" id="restartBtn">Share another secret</button>
    </div>
    
    <div class="how-it-works">
        <h2>How it works?</h2>
        <div class="steps">
            <div class="step-card">
                <div class="step-icon">üîí</div>
                <div class="step-number">1</div>
                <h3>Share anonymously</h3>
                <p>Write your secret and choose your current emotion.</p>
            </div>
            <div class="step-card">
                <div class="step-icon">üîÑ</div>
                <div class="step-number">2</div>
                <h3>Receive a secret</h3>
                <p>Instantly get a secret from someone feeling the same.</p>
            </div>
            <div class="step-card">
                <div class="step-icon">üíå</div>
                <div class="step-number">3</div>
                <h3>Support others</h3>
                <p>Keep, forget, or support a secret.</p>
            </div>
            <div class="step-card">
                <div class="step-icon">ü¶ä</div>
                <div class="step-number">4</div>
                <h3>Release it</h3>
                <p>Share this secret with the whole world!</p>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h2>Your secrets are safe</h2>
        <div class="features">
            <div class="feature">
                <div class="feature-icon">üîê</div>
                <h3>Total anonymity</h3>
                <p>No personal information is collected or stored.</p>
            </div>
            <div class="feature">
                <div class="feature-icon">üîÑ</div>
                <h3>Instant exchanges</h3>
                <p>Receive a similar secret as soon as you share yours.</p>
            </div>
            <div class="feature">
                <div class="feature-icon">üíñ</div>
                <h3>Caring community</h3>
                <p>A judgment-free space to free yourself.</p>
            </div>
            <div class="feature">
                <div class="feature-icon">üõ°Ô∏è</div>
                <h3>Content moderation</h3>
                <p>All secrets are checked for inappropriate content.</p>
            </div>
        </div>
    </div>
    
    <div class="revealed-secrets-container">
        <h2 class="revealed-secrets-title">Revealed Secrets</h2>
        <div class="loading" id="revealedLoading">
            <div class="spinner"></div>
            <p>Loading revealed secrets...</p>
        </div>
        <div class="secrets-grid" id="revealedSecretsGrid">
            <!-- Revealed secrets will be loaded here -->
        </div>
    </div>
    
    <footer>
        <p>¬© 2025 SecretSwap.fun - All rights reserved</p>
        <p>An anonymous and caring space to share what's on your mind</p>
        <p><a href="bitcoin/" target="_blank">Double or nothing </a> | <a href="#">Terms of Use</a></p>
    </footer>

    <script>
        // Configuration - MISE √Ä JOUR AVEC VOTRE URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwlS_w51KtmJVZ0VoJ3j_-os23n4C4OuTEAVzMBRngcJQFGwFQsrezGhVW1p8Wmsvby6w/exec";
        
        // DOM Elements
        const secretInput = document.getElementById('secretInput');
        const charCount = document.getElementById('charCount');
        const lengthError = document.getElementById('lengthError');
        const emotionError = document.getElementById('emotionError');
        const emotionBtns = document.querySelectorAll('.emotion-btn');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('resultContainer');
        const resultTitle = document.getElementById('resultTitle');
        const secretResult = document.getElementById('secretResult');
        const actionsContainer = document.getElementById('actionsContainer');
        const thankYouMessage = document.getElementById('thankYouMessage');
        const actionBtns = document.querySelectorAll('.action-btn');
        const secretFormContainer = document.getElementById('secretFormContainer');
        const revealedLoading = document.getElementById('revealedLoading');
        const revealedSecretsGrid = document.getElementById('revealedSecretsGrid');
        const paypalContainer = document.getElementById('paypalContainer');
        const statsDisplay = document.getElementById('statsDisplay');
        const keepStat = document.getElementById('keepStat');
        const forgetStat = document.getElementById('forgetStat');
        const supportStat = document.getElementById('supportStat');
        const revealStat = document.getElementById('revealStat');
        const restartBtn = document.getElementById('restartBtn');
        const modelStatus = document.getElementById('modelStatus');
        const moderationMessage = document.getElementById('moderationMessage');
        const toxicityLevel = document.getElementById('toxicityLevel');
        
        let selectedEmotion = null;
        let currentRowId = null;
        let actionTaken = false;
        let secretStats = { keep: 0, forget: 0, support: 0, reveal: 0 };
        let toxicityModel = null;
        
        // Initialize toxicity model
        async function initToxicityModel() {
            try {
                modelStatus.style.display = 'block';
                
                // The minimum prediction confidence (0 = zero tolerance)
                const threshold = 0.01;
                
                // Load the toxicity model
                toxicityModel = await toxicity.load(threshold, [
                    'toxicity', 'severe_toxicity', 'identity_attack', 
                    'insult', 'threat', 'sexual_explicit'
                ]);
                
                modelStatus.textContent = "Content moderation model loaded successfully";
                modelStatus.classList.add('loaded');
            } catch (error) {
                modelStatus.textContent = "Error loading moderation model: " + error.message;
                modelStatus.classList.add('error');
                console.error("Toxicity model error:", error);
            }
        }
        
        // Check if text contains code
        function containsCode(text) {
            const codePatterns = [
                /<[a-z][\s\S]*>/i, // HTML tags
                /function\s*\(|=>|\/\/|\.\w+\(|var\s+\w+\s*=|const\s+\w+\s*=|let\s+\w+\s*=/i, // JavaScript
                /\b(?:import|from|require|export|module\.exports|def\s+\w+\s*\(|class\s+\w+)\b/i, // Other languages
                /(?:\b\w+\s*=\s*[\s\S]*?;)|(?:\{\s*[\s\S]*?\})|(?:\(\s*[\s\S]*?\))/ // Code structures
            ];
            
            return codePatterns.some(pattern => pattern.test(text));
        }
        
        // Check text for toxicity
        async function isToxic(text) {
            if (!toxicityModel) return false;
            
            try {
                const predictions = await toxicityModel.classify(text);
                let maxScore = 0;
                
                // Check all predictions
                for (const prediction of predictions) {
                    if (prediction.results[0].match) {
                        const score = prediction.results[0].probabilities[1];
                        if (score > maxScore) maxScore = score;
                    }
                }
                
                // Visual representation of toxicity
                if (maxScore > 0) {
                    toxicityLevel.style.width = `${Math.min(100, maxScore * 100)}%`;
                    moderationMessage.style.display = 'block';
                } else {
                    moderationMessage.style.display = 'none';
                }
                
                return maxScore > 0;
            } catch (error) {
                console.error("Toxicity classification error:", error);
                return false;
            }
        }
        
        // Update character counter
        secretInput.addEventListener('input', () => {
            const text = secretInput.value;
            charCount.textContent = text.length;
            
            // Validate length
            if (text.length < 100) {
                lengthError.style.display = 'block';
            } else {
                lengthError.style.display = 'none';
            }
            
            // Enable/disable submit button
            updateSubmitButton();
        });
        
        // Emotion selection
        emotionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove previous selection
                emotionBtns.forEach(b => b.classList.remove('selected'));
                
                // Select new emotion
                btn.classList.add('selected');
                selectedEmotion = btn.dataset.emotion;
                emotionError.style.display = 'none';
                
                // Update submit button
                updateSubmitButton();
            });
        });
        
        // Update submit button state
        function updateSubmitButton() {
            const text = secretInput.value;
            if (text.length >= 100 && text.length <= 500 && selectedEmotion) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }
        
        // Submit secret with moderation
        submitBtn.addEventListener('click', async () => {
            const secret = secretInput.value;
            
            // Validate inputs
            if (secret.length < 100) {
                lengthError.style.display = 'block';
                return;
            }
            
            if (!selectedEmotion) {
                emotionError.style.display = 'block';
                return;
            }
            
            // Hide any previous moderation messages
            moderationMessage.style.display = 'none';
            
            // Show loading indicator
            loading.style.display = 'block';
            submitBtn.disabled = true;
            
            try {
                // Check for code
                if (containsCode(secret)) {
                    throw new Error("Code detected in secret. Please remove any code and try again.");
                }
                
                // Check for toxicity
                const toxic = await isToxic(secret);
                if (toxic) {
                    throw new Error("Inappropriate content detected. Please rephrase your secret.");
                }
                
                // If all checks pass, send data to Google Sheets
                const response = await fetch(
                    `${SCRIPT_URL}?action=addSecret&secret=${encodeURIComponent(secret)}&emotion=${selectedEmotion}`
                );
                
                if (!response.ok) {
                    throw new Error('Failed to save secret');
                }
                
                const saveResult = await response.json();
                if (saveResult.status !== 'success') {
                    throw new Error(saveResult.message || 'Error saving secret');
                }
                
                // Now get a random secret with the same emotion
                const secretResponse = await fetch(
                    `${SCRIPT_URL}?action=getRandomSecret&emotion=${selectedEmotion}`
                );
                
                if (!secretResponse.ok) {
                    throw new Error('Failed to retrieve secret');
                }
                
                const secretData = await secretResponse.json();
                
                // Hide loading
                loading.style.display = 'none';
                
                // Hide the form container
                secretFormContainer.style.display = 'none';
                
                // Show the result container
                resultContainer.style.display = 'block';
                
                if (secretData.status === "no_secret") {
                    // No secret found for this emotion
                    resultTitle.textContent = "You're the first with this emotion!";
                    secretResult.textContent = "Share your secret to start the exchange. As soon as another person shares a similar secret, you'll receive it.";
                    actionsContainer.style.display = 'none';
                } else {
                    // Show the retrieved secret
                    secretResult.textContent = secretData.secret;
                    currentRowId = secretData.rowId;
                    resultTitle.textContent = "Here is a secret similar to yours:";
                    actionsContainer.style.display = 'flex';
                }
                
                // Reset form (but keep it hidden)
                secretInput.value = '';
                charCount.textContent = '0';
                emotionBtns.forEach(b => b.classList.remove('selected'));
                selectedEmotion = null;
                submitBtn.disabled = true;
                
                // Reset action buttons
                actionBtns.forEach(b => b.disabled = false);
                actionTaken = false;
                
                // Hide PayPal container initially
                paypalContainer.style.display = 'none';
                
                // Hide stats display
                statsDisplay.style.display = 'none';
                
                // Hide thank you message
                thankYouMessage.style.display = 'none';
                
                // Scroll to result
                resultContainer.scrollIntoView({ behavior: 'smooth' });
                
                // Load revealed secrets
                loadRevealedSecrets();
            } catch (error) {
                loading.style.display = 'none';
                submitBtn.disabled = false;
                
                // Show error message
                if (error.message.includes("Inappropriate") || error.message.includes("Code detected")) {
                    moderationMessage.querySelector('p').textContent = error.message;
                    moderationMessage.style.display = 'block';
                } else {
                    alert("An error occurred: " + error.message);
                }
            }
        });
        
        // Handle actions (Keep, Forget, Support, Reveal)
        actionBtns.forEach(btn => {
            btn.addEventListener('click', async () => {
                if (actionTaken) return;
                
                const action = btn.dataset.action;
                actionTaken = true;
                
                // Disable all action buttons
                actionBtns.forEach(b => b.disabled = true);
                
                try {
                    // Send request to increment counter
                    const response = await fetch(
                        `${SCRIPT_URL}?action=increment&rowId=${currentRowId}&counterType=${action}`
                    );
                    
                    if (!response.ok) {
                        throw new Error('Failed to update counter');
                    }
                    
                    const result = await response.json();
                    if (result.status !== 'success') {
                        throw new Error(result.message || 'Error updating counter');
                    }
                    
                    // Get updated stats for this secret
                    const statsResponse = await fetch(
                        `${SCRIPT_URL}?action=getSecretStats&rowId=${currentRowId}`
                    );
                    
                    if (!statsResponse.ok) {
                        throw new Error('Failed to get updated stats');
                    }
                    
                    const statsData = await statsResponse.json();
                    if (statsData.status === 'success') {
                        // Update local stats
                        secretStats.keep = statsData.keep;
                        secretStats.forget = statsData.forget;
                        secretStats.support = statsData.support;
                        secretStats.reveal = statsData.reveal;
                        
                        // Show stats display
                        updateStatsDisplay();
                        statsDisplay.style.display = 'block';
                    }
                    
                    // Show PayPal container only for Reveal action
                    if (action === 'reveal') {
                        paypalContainer.style.display = 'block';
                        
                        // Initialize PayPal button
                        paypal.HostedButtons({
                            hostedButtonId: "DKK8KM24TAJRE",
                        }).render("#paypal-container-DKK8KM24TAJRE");
                    }
                    
                    // Show thank you message
                    thankYouMessage.style.display = 'block';
                    
                    // If action is reveal, reload revealed secrets
                    if (action === 'reveal') {
                        loadRevealedSecrets();
                    }
                } catch (error) {
                    alert("Error: " + error.message);
                    actionBtns.forEach(b => b.disabled = false);
                    actionTaken = false;
                }
            });
        });
        
        // Update stats display
        function updateStatsDisplay() {
            keepStat.textContent = secretStats.keep;
            forgetStat.textContent = secretStats.forget;
            supportStat.textContent = secretStats.support;
            revealStat.textContent = secretStats.reveal;
        }
        
        // Restart button - show form again
        restartBtn.addEventListener('click', () => {
            resultContainer.style.display = 'none';
            secretFormContainer.style.display = 'block';
            secretFormContainer.scrollIntoView({ behavior: 'smooth' });
        });
        
        // Load revealed secrets
        async function loadRevealedSecrets() {
            revealedLoading.style.display = 'block';
            revealedSecretsGrid.innerHTML = '';
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getRevealedSecrets`);
                
                if (!response.ok) {
                    throw new Error('Failed to load revealed secrets');
                }
                
                const data = await response.json();
                
                if (data.status === "success" && data.secrets && data.secrets.length > 0) {
                    data.secrets.forEach(secret => {
                        const secretCard = createSecretCard(secret);
                        revealedSecretsGrid.appendChild(secretCard);
                    });
                } else {
                    revealedSecretsGrid.innerHTML = `
                        <div class="no-secrets" style="text-align: center; grid-column: 1 / -1; padding: 40px;">
                            <h3>No secrets revealed yet</h3>
                            <p>Be the first to reveal a secret that resonates with others!</p>
                        </div>
                    `;
                }
            } catch (error) {
                revealedSecretsGrid.innerHTML = `
                    <div class="error" style="text-align: center; grid-column: 1 / -1; padding: 40px; color: var(--coral);">
                        <h3>Error loading secrets</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                revealedLoading.style.display = 'none';
            }
        }
        
        // Create secret card for revealed secrets
        function createSecretCard(secret) {
            const card = document.createElement('div');
            card.className = 'secret-card';
            
            card.innerHTML = `
                <div class="secret-emotion">${secret.emotion}</div>
                <div class="secret-content">${secret.secret}</div>
                <div class="stats-container">
                    <div class="stat-item keep-stat">
                        <div class="stat-value">${secret.keep}</div>
                        <div class="stat-label">Keep</div>
                    </div>
                    <div class="stat-item forget-stat">
                        <div class="stat-value">${secret.forget}</div>
                        <div class="stat-label">Forget</div>
                    </div>
                    <div class="stat-item support-stat">
                        <div class="stat-value">${secret.support}</div>
                        <div class="stat-label">Support</div>
                    </div>
                    <div class="stat-item reveal-stat">
                        <div class="stat-value">${secret.reveal}</div>
                        <div class="stat-label">Reveal</div>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        // Initial load
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize toxicity model
            await initToxicityModel();
            
            loadRevealedSecrets();
            
            // Update character count on page load
            charCount.textContent = secretInput.value.length;
            updateSubmitButton();
            
            // Hide the result container initially
            resultContainer.style.display = 'none';
            
            // Hide PayPal container initially
            paypalContainer.style.display = 'none';
        });
    </script>
</body>
</html>