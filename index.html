<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecretSwap.fun - Exchange your secrets anonymously</title>
    <script src="https://www.paypal.com/sdk/js?client-id=BAASqHmRUaw9JpJWNA3d0XElWNNDdRQdytHNxWDxEtZTz8gICMWyhyqiKfNtkbc4Q8-f2aYdN5VR_ailf8&components=hosted-buttons&disable-funding=venmo&currency=USD"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/toxicity"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="model-status" id="modelStatus">
        <div class="spinner"></div>
        Loading content moderation model...
    </div>
    
    <header>
        <div class="logo">
            <div class="logo-icon">🤫</div>
            <h1>SecretSwap<span class="fun">.fun</span></h1>
        </div>
        <p class="tagline">Share your secrets anonymously and get one in return</p>
    </header>
    
    <div class="container" id="secretFormContainer">
        <div class="step">
            <h2><span>1</span> Share your secret</h2>
            <textarea 
                id="secretInput" 
                class="secret-input" 
                placeholder="Write what's on your mind... (min 100, max 500 characters)"></textarea>
            <div class="char-count"><span id="charCount">0</span>/500 characters</div>
            <div class="error-message" id="lengthError">Secret must be at least 100 characters long</div>
            <div class="moderation-message" id="moderationMessage">
    <div class="toxicity-summary">Inappropriate content detected</div>
    <p>Your secret contains toxic language or code (<span class="toxicity-percent">0%</span>). Please rephrase your message.</p>
    <div class="toxicity-bar">
        <div class="toxicity-level" id="toxicityLevel"></div>
    </div>
    <div class="toxicity-labels">
        <span>Safe</span>
        <span>Toxic</span>
    </div>
</div>
        </div>
        
        <div class="step">
            <h2><span>2</span> Choose your emotion</h2>
            <div class="emotion-selector">
                <button class="emotion-btn" data-emotion="😤" title="Excessive Pride - Feeling of superiority">😤</button>
                <button class="emotion-btn" data-emotion="🤑" title="Greed - Obsessive desire for possessions">🤑</button>
                <button class="emotion-btn" data-emotion="😒" title="Envy - Resentment of others' success">😒</button>
                <button class="emotion-btn" data-emotion="😠" title="Wrath - Violent and destructive emotion">😠</button>
                <button class="emotion-btn" data-emotion="😏" title="Lust - Uncontrollable desire">😏</button>
                <button class="emotion-btn" data-emotion="😋" title="Gluttony - Excessive pursuit of pleasure">😋</button>
                <button class="emotion-btn" data-emotion="😑" title="Sloth - Lack of energy and interest">😑</button>
            </div>
            <div class="error-message" id="emotionError">Please select an emotion</div>
        </div>
        
        <button id="submitBtn" class="submit-btn" disabled>Share anonymously</button>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Looking for a similar secret...</p>
        </div>
    </div>
    
    <div class="container" id="resultContainer">
        <h2 id="resultTitle">Here is a secret similar to yours:</h2>
        <div class="secret-result" id="secretResult">
            Loading your secret...
        </div>
        
        <div class="actions-container" id="actionsContainer">
            <button class="action-btn keep-btn" data-action="keep">
                <span>📁</span> Keep
            </button>
            <button class="action-btn forget-btn" data-action="forget">
                <span>🧹</span> Forget
            </button>
            <button class="action-btn support-btn" data-action="support">
                <span>🤗</span> Support
            </button>
            <button class="action-btn reveal-btn" data-action="reveal">
                <span>📣</span> Reveal
            </button>
        </div>
        
        <div class="paypal-container" id="paypalContainer">
            <div class="paypal-text">How much do you value this secret?</div>
            <div id="paypal-container-DKK8KM24TAJRE"></div>
        </div>
        
        <div class="stats-display" id="statsDisplay">
            <div class="stats-title">Community Response</div>
            <div class="stats-grid">
                <div class="stat-display">
                    <div class="stat-display-value" id="keepStat">0</div>
                    <div class="stat-display-label">Keep</div>
                </div>
                <div class="stat-display">
                    <div class="stat-display-value" id="forgetStat">0</div>
                    <div class="stat-display-label">Forget</div>
                </div>
                <div class="stat-display">
                    <div class="stat-display-value" id="supportStat">0</div>
                    <div class="stat-display-label">Support</div>
                </div>
                <div class="stat-display">
                    <div class="stat-display-value" id="revealStat">0</div>
                    <div class="stat-display-label">Reveal</div>
                </div>
            </div>
        </div>
        
        <div class="thank-you-message" id="thankYouMessage">
            Thank you for participating!
        </div>
        
        <button class="restart-btn" id="restartBtn">Share another secret</button>
    </div>
    
    <div class="how-it-works">
        <h2>How it works?</h2>
        <div class="steps">
            <div class="step-card">
                <div class="step-icon">🔒</div>
                <div class="step-number">1</div>
                <h3>Share anonymously</h3>
                <p>Write your secret and choose your current emotion.</p>
            </div>
            <div class="step-card">
                <div class="step-icon">🔄</div>
                <div class="step-number">2</div>
                <h3>Receive a secret</h3>
                <p>Instantly get a secret from someone feeling the same.</p>
            </div>
            <div class="step-card">
                <div class="step-icon">💌</div>
                <div class="step-number">3</div>
                <h3>Support others</h3>
                <p>Keep, forget, or support a secret.</p>
            </div>
            <div class="step-card">
                <div class="step-icon">🦊</div>
                <div class="step-number">4</div>
                <h3>Release it</h3>
                <p>Share this secret with the whole world!</p>
            </div>
        </div>
    </div>
    
    <div class="stats-container">
        <h2>Community Secrets Statistics</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">🤫</div>
                <div class="stat-value" id="totalSecrets">0</div>
                <div class="stat-label">Total Secrets</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">😤</div>
                <div class="stat-value" id="emotion1">0</div>
                <div class="stat-label">Excessive Pride</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🤑</div>
                <div class="stat-value" id="emotion2">0</div>
                <div class="stat-label">Greed</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">😒</div>
                <div class="stat-value" id="emotion3">0</div>
                <div class="stat-label">Envy</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">😠</div>
                <div class="stat-value" id="emotion4">0</div>
                <div class="stat-label">Wrath</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">😏</div>
                <div class="stat-value" id="emotion5">0</div>
                <div class="stat-label">Lust</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">😋</div>
                <div class="stat-value" id="emotion6">0</div>
                <div class="stat-label">Gluttony</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">😑</div>
                <div class="stat-value" id="emotion7">0</div>
                <div class="stat-label">Sloth</div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h2>Your secrets are safe</h2>
        <div class="features">
            <div class="feature">
                <div class="feature-icon">🔐</div>
                <h3>Total anonymity</h3>
                <p>No personal information is collected or stored.</p>
            </div>
            <div class="feature">
                <div class="feature-icon">🔄</div>
                <h3>Instant exchanges</h3>
                <p>Receive a similar secret as soon as you share yours.</p>
            </div>
            <div class="feature">
                <div class="feature-icon">💖</div>
                <h3>Caring community</h3>
                <p>A judgment-free space to free yourself.</p>
            </div>
            <div class="feature">
                <div class="feature-icon">🛡️</div>
                <h3>Content moderation</h3>
                <p>All secrets are checked for inappropriate content.</p>
            </div>
        </div>
    </div>
    
    <div class="revealed-secrets-container">
        <h2 class="revealed-secrets-title">Revealed Secrets</h2>
        <div class="loading" id="revealedLoading">
            <div class="spinner"></div>
            <p>Loading revealed secrets...</p>
        </div>
        <div class="secrets-grid" id="revealedSecretsGrid">
            <!-- Revealed secrets will be loaded here -->
        </div>
    </div>
    
    <footer>
        <p>© 2025 SecretSwap.fun - All rights reserved</p>
        <p>An anonymous and caring space to share what's on your mind</p>
        <p><a href="bitcoin/" target="_blank">Double or nothing </a> | <a href="#">Terms of Use</a></p>
    </footer>

    <script>
        // Configuration
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyDhDfjo9rPdoD36ki8ofSvvjLECfnrh2gk9XBgmYoZtJ5JABKYqHM_ofHdGO7mjFO_Ig/exec";
        
        // DOM Elements
        const secretInput = document.getElementById('secretInput');
        const charCount = document.getElementById('charCount');
        const lengthError = document.getElementById('lengthError');
        const emotionError = document.getElementById('emotionError');
        const emotionBtns = document.querySelectorAll('.emotion-btn');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('resultContainer');
        const resultTitle = document.getElementById('resultTitle');
        const secretResult = document.getElementById('secretResult');
        const actionsContainer = document.getElementById('actionsContainer');
        const thankYouMessage = document.getElementById('thankYouMessage');
        const actionBtns = document.querySelectorAll('.action-btn');
        const secretFormContainer = document.getElementById('secretFormContainer');
        const revealedLoading = document.getElementById('revealedLoading');
        const revealedSecretsGrid = document.getElementById('revealedSecretsGrid');
        const paypalContainer = document.getElementById('paypalContainer');
        const statsDisplay = document.getElementById('statsDisplay');
        const keepStat = document.getElementById('keepStat');
        const forgetStat = document.getElementById('forgetStat');
        const supportStat = document.getElementById('supportStat');
        const revealStat = document.getElementById('revealStat');
        const restartBtn = document.getElementById('restartBtn');
        const modelStatus = document.getElementById('modelStatus');
        const moderationMessage = document.getElementById('moderationMessage');
        const toxicityLevel = document.getElementById('toxicityLevel');
        const totalSecrets = document.getElementById('totalSecrets');
        const emotion1 = document.getElementById('emotion1');
        const emotion2 = document.getElementById('emotion2');
        const emotion3 = document.getElementById('emotion3');
        const emotion4 = document.getElementById('emotion4');
        const emotion5 = document.getElementById('emotion5');
        const emotion6 = document.getElementById('emotion6');
        const emotion7 = document.getElementById('emotion7');
        
        let selectedEmotion = null;
        let currentRowId = null;
        let actionTaken = false;
        let secretStats = { keep: 0, forget: 0, support: 0, reveal: 0 };
        let toxicityModel = null;
        
          // Initialize toxicity model with optimal threshold
    async function initToxicityModel() {
        try {
            modelStatus.style.display = 'block';
            // Réglage du seuil à une valeur optimale (0.4)
            const threshold = 0.4;
            toxicityModel = await toxicity.load(threshold, [
                'toxicity', 'severe_toxicity', 'identity_attack', 
                'insult', 'threat', 'sexual_explicit'
            ]);
            
            // Faire disparaître le message après chargement
            setTimeout(() => {
                modelStatus.style.display = 'none';
            }, 1500);
        } catch (error) {
            modelStatus.textContent = "Error loading moderation model: " + error.message;
            modelStatus.classList.add('error');
            console.error("Toxicity model error:", error);
        }
    }
        
        // Check if text contains code
        function containsCode(text) {
            const codePatterns = [
                /<[a-z][\s\S]*>/i,
                /function\s*\(|=>|\/\/|\.\w+\(|var\s+\w+\s*=|const\s+\w+\s*=|let\s+\w+\s*=/i,
                /\b(?:import|from|require|export|module\.exports|def\s+\w+\s*\(|class\s+\w+)\b/i,
                /(?:\b\w+\s*=\s*[\s\S]*?;)|(?:\{\s*[\s\S]*?\})|(?:\(\s*[\s\S]*?\))/
            ];
            return codePatterns.some(pattern => pattern.test(text));
        }
        
    // Check text for toxicity
    async function isToxic(text) {
        if (!toxicityModel) return { isToxic: false, maxScore: 0 };
        try {
            const predictions = await toxicityModel.classify(text);
            let maxScore = 0;
            for (const prediction of predictions) {
                if (prediction.results[0].match) {
                    const score = prediction.results[0].probabilities[1];
                    if (score > maxScore) maxScore = score;
                }
            }
            
            // Afficher le pourcentage de toxicité
            if (maxScore > 0) {
                const toxicityPercent = Math.min(100, Math.round(maxScore * 100));
                toxicityLevel.style.width = `${toxicityPercent}%`;
                document.querySelector('.toxicity-percent').textContent = `${toxicityPercent}%`;
                moderationMessage.style.display = 'block';
            } else {
                moderationMessage.style.display = 'none';
            }
            
            return { isToxic: maxScore > 0, maxScore };
        } catch (error) {
            console.error("Toxicity classification error:", error);
            return { isToxic: false, maxScore: 0 };
        }
    }
        
        // Update character counter
        secretInput.addEventListener('input', () => {
            const text = secretInput.value;
            charCount.textContent = text.length;
            lengthError.style.display = text.length < 100 ? 'block' : 'none';
            updateSubmitButton();
        });
        
        // Emotion selection
        emotionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                emotionBtns.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedEmotion = btn.dataset.emotion;
                emotionError.style.display = 'none';
                updateSubmitButton();
            });
        });
        
        // Update submit button state
        function updateSubmitButton() {
            const text = secretInput.value;
            submitBtn.disabled = !(text.length >= 100 && text.length <= 500 && selectedEmotion);
        }
        
      // Submit secret with moderation - CORRECTION ICI
    submitBtn.addEventListener('click', async () => {
        const secret = secretInput.value;
        if (secret.length < 100) return lengthError.style.display = 'block';
        if (!selectedEmotion) return emotionError.style.display = 'block';
        
        moderationMessage.style.display = 'none';
        loading.style.display = 'block';
        submitBtn.disabled = true;
        
        try {
            if (containsCode(secret)) throw new Error("Code detected in secret. Please remove any code and try again.");
            
            // CORRECTION : Récupérer correctement le résultat de la toxicité
            const toxicityResult = await isToxic(secret);
            if (toxicityResult.isToxic) {
                throw new Error(`Inappropriate content detected (${toxicityResult.maxScore * 100}%). Please rephrase your secret.`);
            }
            
            // ... reste du code inchangé ...
        } catch (error) {
            loading.style.display = 'none';
            submitBtn.disabled = false;
            if (error.message.includes("Inappropriate") || error.message.includes("Code detected")) {
                // CORRECTION : Mettre à jour le message avec le pourcentage
                moderationMessage.querySelector('p').textContent = error.message;
                moderationMessage.style.display = 'block';
            } else {
                console.error("Submission error:", error);
                alert("An error occurred: " + error.message);
            }
        }
    });
            
           
  
        
        // Handle actions (Keep, Forget, Support, Reveal)
        actionBtns.forEach(btn => {
            btn.addEventListener('click', async () => {
                if (actionTaken) return;
                const action = btn.dataset.action;
                actionTaken = true;
                actionBtns.forEach(b => b.disabled = true);
                
                try {
                    const response = await fetch(`${SCRIPT_URL}?action=increment&rowId=${currentRowId}&counterType=${action}`);
                    if (!response.ok) throw new Error('Failed to update counter');
                    
                    const result = await response.json();
                    if (result.status !== 'success') throw new Error(result.message || 'Error updating counter');
                    
                    const statsResponse = await fetch(`${SCRIPT_URL}?action=getSecretStats&rowId=${currentRowId}`);
                    if (!statsResponse.ok) throw new Error('Failed to get updated stats');
                    
                    const statsData = await statsResponse.json();
                    if (statsData.status === 'success') {
                        secretStats.keep = statsData.keep;
                        secretStats.forget = statsData.forget;
                        secretStats.support = statsData.support;
                        secretStats.reveal = statsData.reveal;
                        updateStatsDisplay();
                        statsDisplay.style.display = 'block';
                    }
                    
                    if (action === 'reveal') {
                        paypalContainer.style.display = 'block';
                        paypal.HostedButtons({
                            hostedButtonId: "DKK8KM24TAJRE",
                        }).render("#paypal-container-DKK8KM24TAJRE");
                    }
                    
                    thankYouMessage.style.display = 'block';
                    if (action === 'reveal') loadRevealedSecrets();
                } catch (error) {
                    alert("Error: " + error.message);
                    actionBtns.forEach(b => b.disabled = false);
                    actionTaken = false;
                }
            });
        });
        
        // Update stats display
        function updateStatsDisplay() {
            keepStat.textContent = secretStats.keep;
            forgetStat.textContent = secretStats.forget;
            supportStat.textContent = secretStats.support;
            revealStat.textContent = secretStats.reveal;
        }
        
        // Restart button - show form again
        restartBtn.addEventListener('click', () => {
            resultContainer.style.display = 'none';
            secretFormContainer.style.display = 'block';
            secretFormContainer.scrollIntoView({ behavior: 'smooth' });
        });
        
        // Load revealed secrets
        async function loadRevealedSecrets() {
            revealedLoading.style.display = 'block';
            revealedSecretsGrid.innerHTML = '';
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getRevealedSecrets`);
                if (!response.ok) throw new Error('Failed to load revealed secrets');
                
                const data = await response.json();
                if (data.status === "success" && data.secrets && data.secrets.length > 0) {
                    data.secrets.forEach(secret => {
                        revealedSecretsGrid.appendChild(createSecretCard(secret));
                    });
                } else {
                    revealedSecretsGrid.innerHTML = `
                        <div class="no-secrets">
                            <h3>No secrets revealed yet</h3>
                            <p>Be the first to reveal a secret that resonates with others!</p>
                        </div>
                    `;
                }
            } catch (error) {
                revealedSecretsGrid.innerHTML = `
                    <div class="error">
                        <h3>Error loading secrets</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                revealedLoading.style.display = 'none';
            }
        }
        
        // Create secret card for revealed secrets
        function createSecretCard(secret) {
            const card = document.createElement('div');
            card.className = 'secret-card';
            card.innerHTML = `
                <div class="secret-emotion">${secret.emotion}</div>
                <div class="secret-content">${secret.secret}</div>
                <div class="stats-container">
                    <div class="stat-item keep-stat">
                        <div class="stat-value">${secret.keep}</div>
                        <div class="stat-label">Keep</div>
                    </div>
                    <div class="stat-item forget-stat">
                        <div class="stat-value">${secret.forget}</div>
                        <div class="stat-label">Forget</div>
                    </div>
                    <div class="stat-item support-stat">
                        <div class="stat-value">${secret.support}</div>
                        <div class="stat-label">Support</div>
                    </div>
                    <div class="stat-item reveal-stat">
                        <div class="stat-value">${secret.reveal}</div>
                        <div class="stat-label">Reveal</div>
                    </div>
                </div>
            `;
            return card;
        }
        
        // Load stats
        async function loadStats() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getStats`);
                if (!response.ok) throw new Error('Failed to load stats');
                const data = await response.json();
                if (data.status !== 'success') throw new Error(data.message);
                
                totalSecrets.textContent = data.total;
                emotion1.textContent = data.byEmotion['😤'] || 0;
                emotion2.textContent = data.byEmotion['🤑'] || 0;
                emotion3.textContent = data.byEmotion['😒'] || 0;
                emotion4.textContent = data.byEmotion['😠'] || 0;
                emotion5.textContent = data.byEmotion['😏'] || 0;
                emotion6.textContent = data.byEmotion['😋'] || 0;
                emotion7.textContent = data.byEmotion['😑'] || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Initial load
        document.addEventListener('DOMContentLoaded', async () => {
            await initToxicityModel();
            loadRevealedSecrets();
            charCount.textContent = secretInput.value.length;
            updateSubmitButton();
            resultContainer.style.display = 'none';
            paypalContainer.style.display = 'none';
            loadStats();
        });
    </script>
</body>
</html>